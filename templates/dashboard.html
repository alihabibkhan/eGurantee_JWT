<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    {% include 'head.html' %}

    <style>
        /* â”€â”€ YOUR ORIGINAL STYLES REMAIN UNCHANGED â”€â”€ */
        .dashboard-parent-card {
            background: #f8f9fa;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin: 2rem 0;
            width: 100%;
            max-width: 100%;
            animation: fadeIn 0.8s ease-out;
        }

        .dashboard-metric-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease;
            width: 100%;
        }

        .dashboard-metric-card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .dashboard-metric-card .metric-content {
            text-align: left;
            flex: 1;
        }

        .dashboard-metric-card h2 {
            color: #2d3748;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
        }

        .dashboard-metric-card h3 {
            color: #1a202c;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-metric-card p {
            color: #718096;
            font-size: 0.70rem;
            margin: 0;
        }

        .dashboard-metric-card .no-data {
            color: #a0aec0;
            font-style: italic;
            font-size: 0.9rem;
        }

        .dashboard-metric-card .icon {
            font-size: 1.5rem;
            color: #718096;
            margin-right: 1rem;
        }

        .metrics-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .metrics-container .row {
            width: 100%;
            margin-bottom: 0;
        }

        .metrics-container .col {
            flex: 1;
            min-width: 0;
            padding: 0;
        }

        .metrics-left {
            flex: 1;
            min-width: 160px;
        }

        .metrics-right {
            flex: 1;
            display: flex;
            justify-content: space-between;
            min-width: 160px;
        }

        .currency {
            font-family: 'Arial', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #597E6E;
            border-color: linear-gradient(135deg, #38bdf8, #818cf8);
            color: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn-primary:hover {
            background: #97B6A8;
            border-color: linear-gradient(135deg, #38bdf8, #818cf8);
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .dashboard-parent-card {
                margin: 1rem 0;
                padding: 1.5rem;
            }
            .dashboard-metric-card {
                min-height: 120px;
                flex-direction: column;
                text-align: center;
            }
            .dashboard-metric-card .icon {
                margin-right: 0;
                margin-bottom: 0.5rem;
            }
            .dashboard-metric-card h2 {
                font-size: 0.9rem;
            }
            .dashboard-metric-card h3 {
                font-size: 1.1rem;
            }
            .dashboard-metric-card p {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>

    {% include 'navbar.html' %}

    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url":'', "label":'Dashboard'}]) }}

    <div class="mt-3">
        <div id="messageBox"></div>
    </div>

    <div class="container mt-5 position-relative">

        {% include 'loader.html' %}

        <div class="container mb-3">
            <div class="row me-5 ps-5">
                <div class="d-flex justify-content-between">
                    <a href="{{url_for('view_meeting_calendar')}}" class="btn btn-primary">My Meetings</a>
                    <a href="{{url_for('awaiting_service')}}" id="awaitingBtn" class="btn btn-primary hidden">Awaiting Services</a>
                </div>
            </div>
        </div>

        <div class="dashboard-parent-card shadow-lg">
            <div class="d-flex justify-content-between mb-3">
                <div>
                    <h3>Khushali Foundation at a Glance</h3>
                </div>
                <div>
                    <h3>Portfolio Data as of (<span id="portfolioDate">...</span>)</h3>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-4 g-4" id="metricsRow">
                <!-- Loan Beneficiaries -->
                <div class="col">
                    <div class="dashboard-metric-card">
                        <div class="icon">ğŸ‘¥</div>
                        <div class="metric-content" id="beneficiariesContent">
                            <h2>Loan Beneficiaries</h2>
                            <p class="no-data">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Loan Disbursement -->
                <div class="col">
                    <div class="dashboard-metric-card">
                        <div class="icon">ğŸ’°</div>
                        <div class="metric-content" id="disbursementContent">
                            <h2>Loan Disbursement</h2>
                            <p class="no-data">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Loans -->
                <div class="col">
                    <div class="dashboard-metric-card">
                        <div class="icon">ğŸ“ˆ</div>
                        <div class="metric-content" id="outstandingContent">
                            <h2>Outstanding Loans</h2>
                            <p class="no-data">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Non Performing Loans -->
                <div class="col">
                    <div class="dashboard-metric-card">
                        <div class="icon">âš ï¸</div>
                        <div class="metric-content" id="nplContent">
                            <h2>Non Performing Loans</h2>
                            <p class="no-data">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-parent-card shadow-lg">
            <div class="d-flex justify-content-center mb-3">
                <div>
                    <h3>National Council Distribution</h3>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-4 g-4" id="councilRow">
                <!-- Filled dynamically -->
            </div>
        </div>

    </div>

    <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Fetch & populate dashboard data
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (response.status === 401 || response.status === 422 || response.status === 403) {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to load dashboard data');
            }

            const data = await response.json();

            if (data.status !== 'success') {
                document.getElementById('messageBox').innerHTML = `
                    <div class="alert alert-danger">${data.message || 'Error loading data'}</div>
                `;
                return;
            }

            // Hide loading overlay
            document.getElementById('loadingOverlay').classList.add('hidden');

            // Render all content
            renderDashboard(data);

        } catch (err) {
            console.error('Dashboard error:', err);
            document.getElementById('messageBox').innerHTML = `
                <div class="alert alert-danger">Error: ${err.message}</div>
            `;
        }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Render function â€“ populates your exact layout
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDashboard(data) {

        // Portfolio date â€“ shown as "Portfolio Data as of (YYYY-MM-DD)"
        // Format portfolio date to YYYY-MM-DD
        const rawDate = data.latest_portfolio_date?.latest_record_date;
        let formattedDate = 'N/A';

        if (rawDate) {
            try {
                // Handle common date string formats
                const dateObj = new Date(rawDate);
                if (!isNaN(dateObj.getTime())) {
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    formattedDate = `${year}-${month}-${day}`;
                } else {
                    // If it's already a string in YYYY-MM-DD, use as is
                    if (/^\d{4}-\d{2}-\d{2}$/.test(rawDate)) {
                        formattedDate = rawDate;
                    }
                }
            } catch (e) {
                console.warn('Invalid date format:', rawDate);
            }
        }

        document.getElementById('portfolioDate').textContent = formattedDate;

        // Show/hide Awaiting Services button
        if (data.is_executive_approver || data.is_admin) {
            document.getElementById('awaitingBtn').classList.remove('hidden');
        }

        // â”€â”€ Currency helper (exact same logic as original) â”€â”€
        function formatCurrency(amount) {
            if (!amount) return '<p class="no-data">No data to display</p>';
            let num = parseFloat(amount);
            let suffix = '';
            if (num >= 1000000000) {
                num /= 1000000000;
                suffix = ' Bn';
            } else if (num >= 1000000) {
                num /= 1000000;
                suffix = ' Mn';
            } else if (num >= 100000) {
                num /= 100000;
                suffix = ' Lakhs';
            }
            return `<h3 class="currency"><small class="text-muted">PKR</small> ${num.toFixed(2)}${suffix}</h3>`;
        }

        // â”€â”€ Loan Beneficiaries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let beneficiariesHtml = '<p class="no-data">No data to display</p>';
        const beneData = data.total_loan_beneficiary_count || [];
        let total = 0, male = 0, female = 0;
        beneData.forEach(row => {
            if (row.gender === 'Total')   total  = row.unique_cnic_count || 0;
            if (row.gender === 'Male')    male   = row.unique_cnic_count || 0;
            if (row.gender === 'Female')  female = row.unique_cnic_count || 0;
        });
        if (total > 0) {
            beneficiariesHtml = `
                <h3><small class="text-muted">Total:</small> ${total}</h3>
                <p>Male: ${male} (${((male / total) * 100).toFixed(1)}%)<br>
                   Female: ${female} (${((female / total) * 100).toFixed(1)}%)</p>
            `;
        }
        document.getElementById('beneficiariesContent').innerHTML = `
            <h2>Loan Beneficiaries</h2>${beneficiariesHtml}
        `;

        // â”€â”€ Loan Disbursement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const disbursed = data.disbursed_loan_count?.[0]?.total_disbursed_amount;
        document.getElementById('disbursementContent').innerHTML = `
            <h2>Loan Disbursement</h2>
            ${formatCurrency(disbursed)}
        `;

        // â”€â”€ Outstanding Loans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const outstanding = data.outstanding_loans?.[0]?.total_principal_outstanding;
        document.getElementById('outstandingContent').innerHTML = `
            <h2>Outstanding Loans</h2>
            ${formatCurrency(outstanding)}
        `;

        // â”€â”€ Non Performing Loans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const npl = data.non_performing_loan_count?.[0]?.non_performing_loans;
        document.getElementById('nplContent').innerHTML = `
            <h2>Non Performing Loans</h2>
            ${formatCurrency(npl)}
        `;

        // â”€â”€ National Council Distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const councilRow = document.getElementById('councilRow');
        councilRow.innerHTML = '';

        const areaMetrics = data.area_metrics || [];
        if (areaMetrics.length === 0) {
            councilRow.innerHTML = '<div class="col-12"><p class="no-data text-center">No distribution data available</p></div>';
        } else {
            areaMetrics.forEach(row => {
                councilRow.innerHTML += `
                    <div class="col">
                        <div class="dashboard-metric-card">
                            <div class="icon">ğŸ›ï¸</div>
                            <div class="metric-content">
                                <h2>${row.national_council_distribution || 'Unknown'}</h2>
                                <div class="metrics-container">
                                    <div class="metrics-left">
                                        <h3>${row.total_beneficiaries || 0}</h3>
                                        <p>Beneficiaries</p>
                                    </div>
                                    <div class="metrics-right">
                                        <div>
                                            <h3>${row.disbursed_count || 0}</h3>
                                            <p>Loan Disbursed</p>
                                        </div>
                                        <div>
                                            <h3>${row.active_loan_count || 0}</h3>
                                            <p>Active Loan</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    }
    </script>
</body>
</html>