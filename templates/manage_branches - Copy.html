<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Branches</title>
    {% include 'head.html' %}
    <style>
        .table-responsive {
            margin-bottom: 1rem;
        }
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .pagination .page-item.disabled .page-link {
            cursor: not-allowed;
            opacity: 0.65;
        }
        .card {
            margin-top: 1rem;
        }
        .action-icons a {
            margin-right: 8px;
            cursor: pointer;
        }
        .add-branch-btn {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url":"", "label":"Manage Branches"}]) }}
    <div class="mt-3">
        {% include 'message_box.html' %}
    </div>

    <div class="container py-4">
        <h1 class="mb-4">Manage Branches</h1>

        <a href="{{ url_for('add_edit_branch') }}" class="btn btn-primary add-branch-btn mb-3">Add New Branch</a>

        <!-- Data Table Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Branch Information</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Branch Code</th>
                                <th scope="col">Role</th>
                                <th scope="col">Branch Name</th>
                                <th scope="col">Area</th>
                                <th scope="col">Created By</th>
                                <th scope="col">Created Date</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="branch-table-body"></tbody>
                    </table>
                </div>
                <nav aria-label="Branch pagination">
                    <ul class="pagination justify-content-center" id="branch-pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Branch Details -->
    <div class="modal fade" id="branchDetailModal" tabindex="-1" aria-labelledby="branchDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="branchDetailModalLabel">Branch Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tbody id="branch-detail-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask with fallback
        const branchData = {{ result.get_all_branches_info | tojson | safe }} || [];

        console.log(branchData);

        // Validate data
        if (!Array.isArray(branchData)) {
            console.error('Invalid branch data:', branchData);
            const tbody = document.getElementById('branch-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Error loading data</td></tr>';
            document.getElementById('branch-pagination').innerHTML = '';
        } else {
            // Pagination state
            let branchCurrentPage = 1;
            let filteredData = branchData;

            // Format date
            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return isNaN(date) ? dateStr : date.toLocaleDateString('en-US', { timeZone: 'Asia/Karachi' });
            }

            // Delete branch
            function deleteBranch(branchId) {
                if (!confirm('Are you sure you want to delete this branch?')) {
                    return;
                }

                window.location.href = `/delete-branch/${branchId}`
            }

            // Render table
            function renderTable(data, tableBodyId, currentPage) {
                const tbody = document.getElementById(tableBodyId);
                tbody.innerHTML = '';
                const itemsPerPage = 10;
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageData = data.slice(start, end);

                if (pageData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No records found</td></tr>';
                    return;
                }

                pageData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.branch_code || 'N/A'}</td>
                        <td>${record.role || 'N/A'}</td>
                        <td>${record.branch_name || 'N/A'}</td>
                        <td>${record.area || 'N/A'}</td>
                        <td>${record.createdby || 'N/A'}</td>
                        <td>${formatDate(record.created_date)}</td>
                        <td class="action-icons">
                            <a href="#" class="text-decoration-none" title="View" data-bs-toggle="modal" data-bs-target="#branchDetailModal" onclick="showBranchDetails('${record.branch_id}')">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/edit-branch/${record.branch_id}" class="text-decoration-none" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="#" class="text-decoration-none" title="Delete" onclick="deleteBranch('${record.branch_id}')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Show branch details in modal
            function showBranchDetails(branchId) {
                // Find the record by branch_id
                const record = branchData.find(r => String(r.branch_id) === String(branchId));
                if (!record) {
                    console.error('Branch not found for ID:', branchId);
                    return;
                }

                const tbody = document.getElementById('branch-detail-body');
                tbody.innerHTML = '';
                const fields = [
                    { key: 'bank_code', label: 'Bank Code' },
                    { key: 'branch', label: 'Branch' },
                    { key: 'branch_code', label: 'Branch Code' },
                    { key: 'branch_name', label: 'Branch Name' },
                    { key: 'area', label: 'Area' },
                    { key: 'area_name', label: 'Area Name' },
                    { key: 'role', label: 'Role' },
                    { key: 'branch_manager', label: 'Branch Manager' },
                    { key: 'email', label: 'Email' },
                    { key: 'bank_distribution', label: 'Bank Distribution' },
                    { key: 'national_council_distribution', label: 'National Council Distribution' },
                    { key: 'kft_distribution', label: 'KFT Distribution' },
                    { key: 'createdby', label: 'Created By' },
                    { key: 'created_date', label: 'Created Date', format: formatDate }
                ];

                fields.forEach(field => {
                    if (field.key !== 'branch_id') { // Exclude primary key
                        const row = document.createElement('tr');
                        const value = field.format ? field.format(record[field.key]) : (record[field.key] || 'N/A');
                        row.innerHTML = `
                            <th>${field.label}</th>
                            <td>${value}</td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            }

            // Render pagination
            function renderPagination(data, paginationId, currentPage) {
                const pagination = document.getElementById(paginationId);
                pagination.innerHTML = '';
                const itemsPerPage = 10;
                const totalPages = Math.ceil(data.length / itemsPerPage);
                if (totalPages <= 1) return;

                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" ${currentPage === 1 ? '' : `onclick="changePage(${currentPage - 1})"`}>Previous</a>`;
                pagination.appendChild(prevLi);

                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                if (startPage > 1) {
                    const firstLi = document.createElement('li');
                    firstLi.className = 'page-item';
                    firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
                    pagination.appendChild(firstLi);

                    if (startPage > 2) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(ellipsisLi);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    pagination.appendChild(pageLi);
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(ellipsisLi);
                    }

                    const lastLi = document.createElement('li');
                    lastLi.className = 'page-item';
                    lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
                    pagination.appendChild(lastLi);
                }

                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" ${currentPage === totalPages ? '' : `onclick="changePage(${currentPage + 1})"`}>Next</a>`;
                pagination.appendChild(nextLi);
            }

            // Change page
            function changePage(page) {
                branchCurrentPage = page;
                renderTable(filteredData, 'branch-table-body', branchCurrentPage);
                renderPagination(filteredData, 'branch-pagination', branchCurrentPage);
            }

            // Initial render
            renderTable(filteredData, 'branch-table-body', branchCurrentPage);
            renderPagination(filteredData, 'branch-pagination', branchCurrentPage);
        }
    </script>
</body>
</html>