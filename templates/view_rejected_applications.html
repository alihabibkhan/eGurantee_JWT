<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disagreed Loans Report</title>
    {% include 'head.html' %}
    <style>
        .table-responsive {
            margin-bottom: 1rem;
        }
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .pagination .page-item.disabled .page-link {
            cursor: not-allowed;
            opacity: 0.65;
        }
        .modal-body .row {
            margin-bottom: 0.5rem;
        }
        .modal-body label {
            font-weight: bold;
        }
        .group-heading {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .table-sm textarea {
            width: 100%;
        }
        .letter-iframe {
            width: 100%;
            height: 700px;
            border: none;
            display: block;
        }
        .letter-iframe.loading {
            background: #f8f9fa url('data:image/svg+xml,%3csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3e%3cpath opacity=".5" fill="%23000" d="M20 3.333A16.667 16.667 0 1036.667 20 16.68 16.68 0 0020 3.333zm0 30A13.333 13.333 0 1133.333 20 13.34 13.34 0 0120 33.333z"/%3e%3cpath fill="%23000" d="M26.667 12.667h-4l-6 10h4z"/%3e%3c/svg%3e') no-repeat center;
        }
        .letter-error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }
        .action-buttons .btn {
            margin-right: 0.25rem;
        }
        #emailModal .form-group {
            margin-bottom: 1rem;
        }
        .card {
            margin-top: 1rem;
        }
        #ongoingLoanModal .modal-body {
            position: relative;
        }
        #ongoingLoanModal .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f8f9fa url('data:image/svg+xml,%3csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3e%3cpath opacity=".5" fill="%23000" d="M20 3.333A16.667 16.667 0 1036.667 20 16.68 16.68 0 0020 3.333zm0 30A13.333 13.333 0 1133.333 20 13.34 13.34 0 0120 33.333z"/%3e%3cpath fill="%23000" d="M26.667 12.667h-4l-6 10h4z"/%3e%3c/svg%3e') no-repeat center;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        #ongoingLoanModal .table {
            margin-top: 1rem;
        }
        .filter-card {
            margin-bottom: 1rem;
        }
        .filter-card .form-group {
            margin-bottom: 0;
        }
        .badge-approved {
            background-color: #28a745;
            color: white;
            margin-left: 5px;
        }
        .badge-rejected {
            background-color: #dc3545;
            color: white;
            margin-left: 5px;
        }
    </style>
    <!-- Add jsPDF and autoTable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    {% include 'navbar.html' %}

    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url":'', "label":'Disagreed Loans Report'}]) }}

    <div class="mt-3">{% include 'message_box.html' %}</div>
    <div class="container py-4">
        <h1 class="mb-3 text-muted">Disagreed Loans Report</h1>

        <!-- Filter Card -->
        <div class="card filter-card">
            <div class="card-header">
                <h5 class="mb-0">Filters and Export</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="start-date">Start Date (Report Period)</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date">End Date (Report Period)</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="sort-by">Sorted By</label>
                        <select id="sort-by" class="form-control">
                            <option value="">Select</option>
                            <option value="ApplicationDate">Application Date</option>
                            <option value="Loan_Amount">Loan Amount</option>
                            <option value="rejected_by">Disagreed By</option>
                            <option value="notes">Reasons for Disagreement</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary form-control" onclick="applyFilters()">Apply Filters</button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button class="btn btn-success" onclick="exportToExcel()">Export to Excel (CSV)</button>
                        <button class="btn btn-info" onclick="exportToPDF()">Export to PDF</button>
                        <button class="btn btn-secondary" onclick="printTable()">Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Rejected Applications</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="print-table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Application No</th>
                                <th scope="col">Branch</th>
                                <th scope="col">Loan Product</th>
                                <th scope="col">Borrower Name</th>
                                <th scope="col">Loan Amount</th>
                                <th scope="col">Reason</th>
                                <th scope="col">Rejected By</th>
                                <th scope="col">Rejected Date</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="temp-table-body"></tbody>
                    </table>
                </div>
                <nav aria-label="Temp pagination">
                    <ul class="pagination justify-content-center" id="temp-pagination"></ul>
                </nav>
            </div>
        </div>

        <!-- Temp Modal -->
        <div class="modal fade" id="tempModal" tabindex="-1" aria-labelledby="tempModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="tempModalLabel">View Record</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="temp-modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <!--<button type="button" class="btn btn-info" id="ongoing-loan-btn" onclick="viewOngoingLoan(event)">View On-going Loan</button>-->
                        <!--<button type="button" class="btn btn-primary" id="temp-save-btn">Save</button>-->
                    </div>
                </div>
            </div>
        </div>

        <!-- Letter Modal -->
        <div class="modal fade" id="letterModal" tabindex="-1" aria-labelledby="letterModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="letterModalLabel">View Approval Letter</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <iframe id="letter-iframe" class="letter-iframe"></iframe>
                        <div id="letter-error" class="letter-error" style="display: none;">Failed to load the approval letter. Please check the application number or try again later.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        {% if result.is_user_have_sign and result.is_reviewer == False %}
                            <button id="send-email-btn" class="btn btn-success" style="display: none;" onclick="showEmailModal()">Send Email</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Modal -->
        <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="emailModalLabel">Send Approval Letter via Email</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="recipient-email">Recipient Email:</label>
                            <input type="email" class="form-control" id="recipient-email" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="send-email-confirm-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- On-going Loan Modal -->
        <div class="modal fade" id="ongoingLoanModal" tabindex="-1" aria-labelledby="ongoingLoanModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ongoingLoanModalLabel"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="ongoing-loan-body">
                        <div class="loading" id="ongoing-loading"></div>
                        <table class="table table-bordered table-hover" id="ongoing-loan-table" style="display: none;">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">MIS Date</th>
                                    <th scope="col">CNIC</th>
                                    <th scope="col">Disbursed Amount</th>
                                    <th scope="col">Booked On</th>
                                    <th scope="col">Principal Outstanding</th>
                                    <th scope="col">Markup Outstanding</th>
                                    <th scope="col">Purpose</th>
                                    <th scope="col">Loan Status</th>
                                    <th scope="col">Overdue Days</th>
                                    <th scope="col">Loan Closed on</th>
                                </tr>
                            </thead>
                            <tbody id="ongoing-loan-table-body"></tbody>
                        </table>
                        <div id="ongoing-error" class="letter-error" style="display: none;">Failed to load on-going loan details. Please try again later.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask
        const tempData = {{ result.get_temp_pre_disbursement | tojson }};
        const loanMetrics = {{ result.get_all_loan_metrics | tojson }};
        console.log(loanMetrics)
        const itemsPerPage = 10;

        // Pagination state
        let tempCurrentPage = 1;
        let filteredData = tempData;

        // Status mapping
        const statusMap = {
            '1': 'Pending',
            '2': 'Approved',
            '3': 'Rejected',
            '4': 'Reviewed'
        };

        // All possible fields for display
        const allFields = [
            'Application_No', 'Annual Business Incomes', 'Annual Disposable Income', 'Annual Expenses',
            'ApplicationDate', 'Bcc Approval_Date', 'Borrower Name', 'Branch Area', 'Branch_Name',
            'Business Expense Description', 'Business Experiense', 'Business_Premises', 'CNIC',
            'Collage_Univeristy', 'collateral_type', 'Contact No', 'Credit_History_Ecib', 'Current Residencial',
            'Dbr', 'education_level', 'enrollment_status', 'Enterprise_Premises', 'Existing_Loan_Number',
            'Existing_Loan_Limit', 'Existing_Loan_Status', 'Existing Outstanding_Loan_Schedules',
            'Experiense_Start_Date', 'Family_Monthly_Income', 'Father_Husband_Name', 'Gender',
            'KF_Remarks', 'Loan_Amount', 'Loan_Cycle', 'LoanProductCode', 'Loan_Status',
            'Monthly_Repayment_Capacity', 'Nature_Of_Business', 'No_Of_Family_Members',
            'Permanent_Residencial', 'Premises', 'Purpose_Of_Loan', 'Requested_Loan_Amount',
            'Residance_Type', 'Student_Name', 'Student_Co_Borrower_Gender', 'Student_Relation_With_Borrower',
            'Tenor_Of_Month', 'Type_of_business', 'annual_income'
        ];

        // Format date
        function formatDate(dateStr) {
          if (!dateStr) return 'Not Received';
          const date = new Date(dateStr);

          // Check for invalid or placeholder dates
          if (
            isNaN(date) ||
            date.toLocaleDateString() === '1/1/1900' ||
            date.toLocaleDateString() === '1900/1/1' ||
            dateStr === '1900-01-01 00:00:00'
          ) {
            return 'Not Received';
          }

          // Format: Apr/21/2025
          const options = { month: 'short', day: '2-digit', year: 'numeric' };
          const formatted = date.toLocaleDateString('en-US', options);

          // Replace comma with slash
          console.log('formatted:- ', formatted)
          return formatted.replace(', ', '/').replace(' ', '/');
        }

        // Parse date for filtering/sorting
        function parseDate(dateStr) {
          if (!dateStr) return null;
          return new Date(dateStr);
        }

        // Apply filters and sorting
        function applyFilters() {
            let startDate = document.getElementById('start-date').value ? parseDate(document.getElementById('start-date').value) : null;
            let endDate = document.getElementById('end-date').value ? parseDate(document.getElementById('end-date').value) : null;
            let sortBy = document.getElementById('sort-by').value;

            filteredData = tempData.filter(record => {
                let rejectedDate = parseDate(record.rejected_date);
                if (startDate && rejectedDate < startDate) return false;
                if (endDate && rejectedDate > endDate) return false;
                return true;
            });

            if (sortBy) {
                filteredData.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];
                    if (sortBy === 'ApplicationDate') {
                        valA = parseDate(valA) || new Date(0);
                        valB = parseDate(valB) || new Date(0);
                    } else if (sortBy === 'Loan_Amount') {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    } else if (sortBy === 'notes' || sortBy === 'rejected_by') {
                        valA = valA ? valA.toLowerCase() : '';
                        valB = valB ? valB.toLowerCase() : '';
                    }
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                    return 0;
                });
            }

            tempCurrentPage = 1;
            renderTable(filteredData, 'temp-table-body', tempCurrentPage);
            renderPagination(filteredData, 'temp-pagination', tempCurrentPage);
        }

        // Render table
        function renderTable(data, tableBodyId, currentPage) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = data.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No records found</td></tr>';
                return;
            }

            pageData.forEach((record, index) => {
                const row = document.createElement('tr');
                const statusText = statusMap[record.status] || 'Not Received';
                let letterButton = '';
                {% if result.is_user_have_sign %}
                    if (record.status === '2') {
                        let badge = '';
                        if (record.email_status === 2) {
                            badge = '<span class="badge badge-approved">Email Sent</span>';
                        } else if (record.email_status === 3) {
                            badge = '<span class="badge badge-rejected">Email Rejected</span>';
                        }
                        {% if result.is_reviewer == False %}
                            letterButton = `<button class="btn btn-sm btn-info" onclick="viewLetter('${record.pre_disb_temp_id}', '${record.email_status}')"><i class="bi bi-envelope"></i>${badge}</button>`;
                        {% endif %}
                    }
                {% endif %}
                row.innerHTML = `
                    <td>${record.Application_No || 'Not Received'}</td>
                    <td>${record.Branch_Name || 'Not Received'}</td>
                    <td>${record.LoanProductCode || 'Not Received'}</td>
                    <td>${record['Borrower_Name'] || 'Not Received'}</td>
                    <td>${record['Loan_Amount'] || 'Not Received'}</td>
                    <td class="text-truncate" title="${record.notes}" style="max-width: 150px;">${record.notes}</td>
                    <td>${record.rejected_by || 'Not Received'}</td>
                    <td title='${record.rejected_date}'>${formatDate(record.approved_date)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewRecord(${start + index})">View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render pagination
        function renderPagination(data, paginationId, currentPage) {
            const pagination = document.getElementById(paginationId);
            pagination.innerHTML = '';
            const totalPages = Math.ceil(data.length / itemsPerPage);
            if (totalPages <= 1) return;

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" ${currentPage === 1 ? '' : `onclick="changePage(${currentPage - 1})"`}>Previous</a>`;
            pagination.appendChild(prevLi);

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
                pagination.appendChild(firstLi);

                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" ${currentPage === totalPages ? '' : `onclick="changePage(${currentPage + 1})"`}>Next</a>`;
            pagination.appendChild(nextLi);
        }

        // Change page
        function changePage(page) {
            tempCurrentPage = page;
            renderTable(filteredData, 'temp-table-body', tempCurrentPage);
            renderPagination(filteredData, 'temp-pagination', tempCurrentPage);
        }

        // View record in modal
        function viewRecord(index) {
            const record = filteredData[index];
            console.log(record)
            const productCode = record.LoanProductCode;
            const applicantGender = record.Gender;

            console.log(productCode, applicantGender)

            const proposedLoanMetric = findMatchingLoanMetric(loanMetrics, productCode, applicantGender);
            console.log('proposedLoanMetric:-');
            console.log(proposedLoanMetric);

            let interest_rate = 0;
            let loanCeilingLoanMetrics = 0;
            let requiredPaidOffPerLoanMetrics = 0;
            let repeatIncrementPerLoanMetrics = 0;

            if(proposedLoanMetric)
            {
                interest_rate = proposedLoanMetric.interest_rate || 0;
                console.log('interest_rate:- ', interest_rate);

                loanCeilingLoanMetrics = proposedLoanMetric.global_loan_ceiling || 0;
                console.log('loanCeilingLoanMetrics:- ', loanCeilingLoanMetrics);

                requiredPaidOffPerLoanMetrics =  proposedLoanMetric.required_paid_off || 0;
                console.log('requiredPaidOffPerLoanMetrics:- ', requiredPaidOffPerLoanMetrics);

                repeatIncrementPerLoanMetrics = proposedLoanMetric.repeat_increment || 0;
                console.log('repeatIncrementPerLoanMetrics:- ', repeatIncrementPerLoanMetrics);
            }

            const modalBody = document.getElementById('temp-modal-body');
            modalBody.innerHTML = '';
            modalBody.setAttribute('data-index', index);

            // Heading for Lender & Borrower Information
            const heading = document.createElement('div');
            heading.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Bank & Borrower Information
                </h4>
            `;
            modalBody.appendChild(heading);

            // Table for Lender & Borrower Information
            const tableContainer = document.createElement('div');
            tableContainer.className = 'row mt-3';
            tableContainer.innerHTML = `
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><th>Application No:</th><td>${record.Application_No || 'Not Received'}</td></tr>
                        <tr><th>Bank Loan Officer:</th><td>Not Received</td></tr>
                        <tr><th>Borrower Name:</th><td>${record.Borrower_Name || 'Not Received'}</td></tr>
                        <tr><th>CNIC #:</th><td>${record.CNIC || 'Not Received'}</td></tr>
                        <tr><th>Borrower Date of Birth / Age:</th><td>Not Received</td></tr>
                        <tr><th>Borrower - Gender:</th><td>${record.Gender || 'Not Received'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><th>Bank Name:</th><td>Not Received</td></tr>
                        <tr><th>Branch Name:</th><td>${record.Branch_Name || 'Not Received'}</td></tr>
                        <tr><th>Student Name/Co-Borrower:</th><td>${record.Student_Name || 'Not Received'}</td></tr>
                        <tr><th>Student Relation with Borrower:</th><td>${record.Student_Relation_With_Borrower || 'Not Received'}</td></tr>
                        <tr><th>Student Co-Borrower DOB / Age:</th><td>Not Received</td></tr>
                        <tr><th>Student Co-Borrower Gender:</th><td>${record.Student_Co_Borrower_Gender || 'Not Received'}</td></tr>
                    </table>
                </div>
            `;
            modalBody.appendChild(tableContainer);

            // Heading for Loan History
            const loanHistoryHeading = document.createElement('div');
            loanHistoryHeading.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 mt-4 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Loan History
                </h4>
            `;
            modalBody.appendChild(loanHistoryHeading);

            // Loan History Section with Loading
            const loanHistoryContainer = document.createElement('div');
            loanHistoryContainer.className = 'row mt-3';
            loanHistoryContainer.innerHTML = `
                <div class="col-md-12" id="loan-history-container">
                    <div id="loan-history-loading" style="display: block; text-align: center; padding: 20px;">
                        Loading loan history...
                    </div>
                    <table class="table table-sm" id="loan-history-table" style="display: none;">
                        <thead id="loan-history-thead"></thead>
                        <tbody id="loan-history-table-body"></tbody>
                    </table>
                    <div id="loan-history-error" style="display: none; color: red; text-align: center; padding: 10px;">
                        No loan history found.
                    </div>
                </div>
            `;
            modalBody.appendChild(loanHistoryContainer);

            // Fetch loan history
            if (record && record.CNIC) {
                const cnic = record.CNIC;
                const loadingDiv = document.getElementById('loan-history-loading');
                const table = document.getElementById('loan-history-table');
                const errorDiv = document.getElementById('loan-history-error');
                const thead = document.getElementById('loan-history-thead');
                const tbody = document.getElementById('loan-history-table-body');

                loadingDiv.style.display = 'block';
                table.style.display = 'none';
                errorDiv.style.display = 'none';
                thead.innerHTML = '';
                tbody.innerHTML = '';

                fetch(`/get_on_going_loan_details?cnic=${encodeURIComponent(cnic)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    if (data.success && data.records.length > 0) {
                        table.style.display = 'table';

                        // Create header row with static headings and dynamic cycle columns
                        const headerRow = document.createElement('tr');
                        headerRow.innerHTML = `<th> </th>`; // Static empty header
                        data.records.forEach((record, index) => {
                            headerRow.innerHTML += `<th>${index + 1}st Cycle</th>`;
                        });
                        thead.appendChild(headerRow);

                        // Create rows with static headings and dynamic data
                        const headings = [
                            'Product Name:', 'Date Disbursed On:',
                            'Date Loan Closed on / Last Payment Received on:', 'Loan Amount:',
                            'Loan Balance (If any):', 'NPL Reported (If any):'
                        ];
                        headings.forEach(heading => {
                            const row = document.createElement('tr');
                            row.innerHTML = `<th>${heading}</th>`;
                            data.records.forEach(record => {
                                let value = '';
                                switch (heading) {
                                    case 'Product Name:':
                                        value = record.product_code || 'Not Received';
                                        break;
                                    case 'Date Disbursed On:':
                                        value = formatDate(record.booked_on) || 'Not Received';
                                        break;
                                    case 'Date Loan Closed on / Last Payment Received on:':
                                        value = formatDate(record.loan_closed_on) || 'Not Received';
                                        break;
                                    case 'Loan Amount:':
                                        value = formatNumber(record.disbursed_amount) || 'Not Received';
                                        break;
                                    case 'Loan Balance (If any):':
                                        value = formatNumber(record.principal_outstanding) || 'Not Received';
                                        break;
                                    case 'NPL Reported (If any):':
                                        value = record.overdue_days > 0 ? 'Yes' : 'No' || 'Not Received';
                                        break;
                                }
                                row.innerHTML += `<td>${value}</td>`;
                            });
                            tbody.appendChild(row);
                        });
                    } else {
                        errorDiv.style.display = 'block';
                    }
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    console.error('Error fetching on-going loan details:', error);
                });
            }

            // Heading for Key Loan Information
            const keyLoanHeading = document.createElement('div');
            keyLoanHeading.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 mt-4 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Key Loan Information
                </h4>
            `;
            modalBody.appendChild(keyLoanHeading);

            // Table for Business Indicators with three columns
            const businessIndicators = document.createElement('div');
            businessIndicators.className = 'row mt-3';
            businessIndicators.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-info text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #007bff;">
                        Business Indicators
                    </h5>
                    <table class="table table-sm">
                        <tr><th>Loan Product:</th><td>${record.LoanProductCode || 'Not Received'}</td><td></td></tr>
                        <tr><th>Nature of Business:</th><td>${record.Nature_Of_Business || 'Not Received'}</td><td>
                            <select class="form-select form-select-sm" id="nature-of-business">
                                <option value="">Select</option>
                                {% for item in result.occupation_list %}
                                    <option value="{{item['name']}}">{{item['name']}}</option>
                                {% else %}
                                    <option value="">[[No record found!]]</option>
                                {% endfor %}
                            </select>
                        </td></tr>
                        <tr><th>Purpose of the Loan:</th><td>${record.Purpose_Of_Loan || 'Not Received'}</td><td></td></tr>
                        <tr><th>Enterprise Premises:</th><td>${record.Enterprise_Premises || 'Not Received'}</td><td></td></tr>
                        <tr><th>Experience Start Date:</th><td>${formatDate(record.Business_Experiense_Since) || 'Not Received'}</td><td>
                            <select class="form-select form-select-sm" id="experience">
                                <option value="">Select</option>
                                {% for item in result.experience_ranges_list %}
                                    <option value="{{item['label']}}">{{item['label']}}</option>
                                {% else %}
                                    <option value="">[[No record found!]]</option>
                                {% endfor %}
                            </select>
                        </td></tr>
                        <tr><th>Credit History ECIB:</th><td>${record.Credit_History_Ecib || 'Not Received'}</td><td></td></tr>
                        <tr><th>Annual Business Income:</th><td>${formatNumber(record.Annual_Business_Incomes) || 'Not Received'}</td><td></td></tr>
                        <tr><th>Annual Expenses:</th><td>${formatNumber(record.Annual_Expenses)|| 'Not Received'}</td><td></td></tr>
                        <tr><th>Annual Disposable Income:</th><td>${formatNumber(record.Annual_Disposable_Income) || 'Not Received'}</td><td></td></tr>
                        <tr><th>Monthly Repayment Capacity:</th><td>${record.Monthly_Repayment_Capacity || 'Not Received'}</td><td></td></tr>
                        <tr><th>Debt Burden Ratio (DBR):</th><td>${record.Dbr || 'Not Received'}</td><td></td></tr>
                    </table>
                </div>
            `;
            modalBody.appendChild(businessIndicators);

            // Table for Family Info
            const familyInfo = document.createElement('div');
            familyInfo.className = 'row mt-3';
            familyInfo.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-success text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #28a745;">
                        Family Information
                    </h5>
                    <table class="table table-sm">
                        <tr><th>Family Monthly Income:</th><td>${formatNumber(record.Family_Monthly_Income) || 'Not Received'}</td></tr>
                        <tr><th>No of Family Members:</th><td>${record.No_Of_Family_Members || 'Not Received'}</td></tr>
                        <tr><th>Residence Type:</th><td>${record.Residance_Type || 'Not Received'}</td></tr>
                    </table>
                </div>
            `;
            modalBody.appendChild(familyInfo);

            // Heading for KFT ACCEPTED Loan Terms
            const kftLoanHeading = document.createElement('div');
            kftLoanHeading.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 mt-4 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Loan Calculator & KFT Loan Matrix
                </h4>
            `;
            modalBody.appendChild(kftLoanHeading);

            // Table for Paid Off %
            const calculatorMathsPaidOff = document.createElement('div');
            calculatorMathsPaidOff.className = 'row mt-3';
            calculatorMathsPaidOff.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-info text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #007bff;">
                        KFT Required Paid off % for Repeat Loan
                    </h5>

                    <table class="table table-sm" id="tableCalculatorMathsPaidOff">
                    </table>
                </div>
            `;
            modalBody.appendChild(calculatorMathsPaidOff);

            // Table for KFT Required Loan Exposure
            const calculatorMathsLoanCeiling = document.createElement('div');
            calculatorMathsLoanCeiling.className = 'row mt-3';
            calculatorMathsLoanCeiling.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-info text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #007bff;">
                        KFT Required Loan Exposure
                    </h5>
                    <table class="table table-sm" id="tableCalculatorMathsLoanCeiling">
                    </table>
                </div>
            `;
            modalBody.appendChild(calculatorMathsLoanCeiling);

            // Table for Loan Limit Per KFT Matrix
            const calculatorMathsLoanLimit = document.createElement('div');
            calculatorMathsLoanLimit.className = 'row mt-3';
            calculatorMathsLoanLimit.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-info text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #007bff;">
                        Loan Limit Per KFT Matrix
                    </h5>
                    <table class="table table-sm" id="tableCalculatorMathsLoanLimit">
                    </table>
                </div>
            `;
            modalBody.appendChild(calculatorMathsLoanLimit);

            // Table for KFT Approved Terms
            const kftAcceptedLoanTerms = document.createElement('div');
            kftAcceptedLoanTerms.className = 'row mt-3';
            kftAcceptedLoanTerms.innerHTML = `
                <div class="col-md-12">
                    <h5 class="bg-success text-white p-2 mb-2 rounded" style="font-weight: bold; border-left: 4px solid #28a745;">
                        KFT Agreed Terms
                    </h5>
                    <table class="table table-sm">
                        <tr><th>KFT Approved Loan Limit:</th><td>
                            <div class="input-group">
                                <input class="form-control form-control-sm" type="text" value="${record.kft_approved_loan_limit !== null ? record.kft_approved_loan_limit : record.Loan_Amount}" id="amount-accepted" readonly>
                            </div>
                        </td></tr>
                        <tr><th>Tenure (Tenure of Months):</th><td>${record.Tenor_Of_Month || 'Not Received'}</td></tr>
                        <tr><th>Collateral Type:</th><td>${record.Collateral_Type || 'Not Received'}</td></tr>
                        <tr><th>Bank Approved Interest Rate (Yet to Receive):</th><td>Not Received</td></tr>
                        <tr><th>KFT Subsidized Interest Rate:</th><td id="td-interest-rate">${interest_rate}%</td></tr>
                         <tr><th>Repayment Terms (Yet to Receive):</th><td>Not Received</td></tr>
                        <tr><th>Reviewed By (Reviewed Date):</th><td>${record.reviewed_by || 'Not Received'} (${formatDate(record.reviewed_date)})</td></tr>
                        <tr><th>Approved By (Approved Date):</th><td>${record.approved_by || 'Not Received'} (${formatDate(record.approved_date)})</td></tr>
                        <tr><th>Status:</th><td>
                            <select class="form-select form-select-sm" id="temp-status" disabled>
                                {% if result.is_reviewer or result.is_approver or result.is_executive_approver or result.is_admin %}
                                    <option value="1" ${record.status === '1' ? 'selected' : ''}>Under Review</option>
                                {% endif %}

                                {% if result.is_approver or result.is_executive_approver or result.is_admin %}
                                    <option value="2" ${record.status === '2' ? 'selected' : ''}>Agreed</option>
                                    <option value="3" ${record.status === '3' ? 'selected' : ''}>Disagreed</option>
                                {% endif %}

                                {% if result.is_reviewer or result.is_admin %}
                                    <option value="4" ${record.status === '5' ? 'selected' : ''}>Recommended for Agreement</option>
                                    <option value="5" ${record.status === '6' ? 'selected' : ''}>Recommended for Disagreement</option>
                                {% endif %}
                            </select>
                        </td></tr>
                        <tr>
                            <th>Exceptions/Notes:</th>
                            <td>
                                <textarea class="form-control" id="temp-notes" rows="4" readonly>${record.notes || ''}</textarea>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
            modalBody.appendChild(kftAcceptedLoanTerms);

            // Heading for Turnaround Time
            const othersHeading = document.createElement('div');
            othersHeading.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 mt-4 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Turnaround Time
                </h4>
            `;
            modalBody.appendChild(othersHeading);

            // Table for Turnaround Time
            const othersTable = document.createElement('div');
            othersTable.className = 'row mt-3';
            othersTable.innerHTML = `
                <div class="col-md-12">
                    ${generateTurnaroundTable(record)}
                </div>
            `;
            modalBody.appendChild(othersTable);

            // Heading for Other Available Information
            const othersAvailableInfo = document.createElement('div');
            othersAvailableInfo.innerHTML = `
                <h4 class="bg-primary text-white p-3 mb-3 mt-4 rounded" style="font-weight: bold; border-left: 5px solid #0052cc;">
                    Other Available Information
                </h4>
            `;
            modalBody.appendChild(othersAvailableInfo);

            // Table for Other Available Information
            const othersAvailableInfoTable = document.createElement('div');
            othersAvailableInfoTable.className = 'row mt-3';
            othersAvailableInfoTable.innerHTML = `
                <div class="col-md-12">
                    <table class="table table-sm">
                        <tr><th>Existing Loan Number:</th><td>${record.Existing_Loan_Number || 'Not Received'}</td></tr>
                        <tr><th>Fathers/Husband Name:</th><td>${record.Father_Husband_Name || 'Not Received'}</td></tr>
                        <tr><th>Borrower Contact Number:</th><td>${record.Contact_No || 'Not Received'}</td></tr>
                        <tr><th>Branch Area:</th><td>${record.Branch_Area || 'Not Received'}</td></tr>
                        <tr><th>Current Residential:</th><td>${record.Current_Residencial || 'Not Received'}</td></tr>
                        <tr><th>Permanent Residential:</th><td>${record.Permanent_Residencial || 'Not Received'}</td></tr>
                        <tr><th>Student Education Level:</th><td>${record.Education_Level || 'Not Received'}</td></tr>
                        <tr><th>Student College University:</th><td>${record.Collage_Univeristy || 'Not Received'}</td></tr>
                        <tr><th>Student Enrollment Status:</th><td>${record.Enrollment_Status || 'Not Received'}</td></tr>
                    </table>
                </div>
            `;
            modalBody.appendChild(othersAvailableInfoTable);

            /*
            const saveBtn = document.getElementById('temp-save-btn');
            saveBtn.onclick = () => saveTempRecord(record.pre_disb_temp_id, saveBtn);
            */
            // Single event handler for changes
            function onFieldChange() {
              const natureOfBusiness = document.getElementById('nature-of-business').value;
              const experience = document.getElementById('experience').value;

              console.log('natureOfBusiness, experience')
              console.log(natureOfBusiness, experience)
              // Pass them into your existing check function
              checkAgainstLoanMetrics(record, natureOfBusiness, experience);
            }

            // Attach handler to dropdowns and loan amount
            document.getElementById('nature-of-business').addEventListener('change', onFieldChange);
            document.getElementById('experience').addEventListener('change', onFieldChange);


            const modal = new bootstrap.Modal(document.getElementById('tempModal'));
            modal.show();

            generateLoanStatusTable(record, requiredPaidOffPerLoanMetrics);
            generateLoanCeilingTable(record, loanCeilingLoanMetrics);
            generateLoanLimitTable(record, repeatIncrementPerLoanMetrics);
        }

        // Helper function to format numbers or return Not Received
        function formatNumber(value) {
        console.log('formatNumber value:- ', value)
          if (value === undefined || value === null || isNaN(value)) return 'Not Received';

          let strValue = value.toString();

          // If the value contains a decimal point
          if (strValue.includes(".")) {
              let [intPart, decimalPart] = strValue.split(".");
              intPart = intPart.replace(',','');

              // Format only the integer part
              let formattedInt = Number(intPart.replace(/,/g, "")).toLocaleString("en-US");
              console.log('formattedInt:- ', formattedInt)
              // Limit decimal part to 2 digits
              decimalPart = decimalPart.length > 2 ? decimalPart.substring(0, 2) : decimalPart;
              return `${formattedInt}.${decimalPart}`;
          }

          // If no decimal, format normally with 2 decimals
          return Number(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }



        // Helper function to format percentage
        function formatPercentage(value) {
            if (value === undefined || value === null || isNaN(value)) return 'Not Received';
            return `${(value).toFixed(2)}%`;
        }

        function generateLoanStatusTable(record, requiredPaidOffPerLoanMetrics) {
            requiredPaidOffPerLoanMetricsDecimal = parseFloat(requiredPaidOffPerLoanMetrics) / 100
            console.log(requiredPaidOffPerLoanMetricsDecimal)


            // Extract input values or set to null if Not Received
            const existingLoanLimit = record.Existing_Loan_Limit && !isNaN(record.Existing_Loan_Limit) ? parseFloat(record.Existing_Loan_Limit) : null;
            const outstandingLoan = record.Existing_Outstanding_Loan_Schedules && !isNaN(record.Existing_Outstanding_Loan_Schedules) ? parseFloat(record.Existing_Outstanding_Loan_Schedules) : null;

            // Calculate Loan Outstanding (%)
            const loanOutstandingPercent = (existingLoanLimit && outstandingLoan) ? (outstandingLoan / existingLoanLimit) * 100 : 0;

            // Calculate Paid Off
            const paidOff = (existingLoanLimit && outstandingLoan) ? existingLoanLimit - outstandingLoan : 0;

            // Calculate Paid Off (%)
            const paidOffPercent = (existingLoanLimit && paidOff) ? (paidOff / existingLoanLimit) * 100 : 0;

            // Calculate Required Paid-Off (75% of Loan Limit)
            const requiredPaidOff = existingLoanLimit ? existingLoanLimit * requiredPaidOffPerLoanMetricsDecimal : 0;

            // Calculate Paid Off Actual vs Required
            const paidOffVsRequired = (paidOff && requiredPaidOff) ? paidOff - requiredPaidOff : 0;
            const paidOffVsRequiredPercent = (existingLoanLimit && paidOffVsRequired) ? (paidOffVsRequired / existingLoanLimit) * 100 : 0;

            // Generate HTML table
            html = `
                <tr>
                    <th>Existing Loan Status:</th>
                    <td>${record.Existing_Loan_Status || 'Not Received'}</td>
                    <td></td>
                </tr>
                <tr>
                    <th>Loan Cycle:</th>
                    <td>${record.Loan_Cycle || 'Not Received'}</td>
                    <td></td>
                </tr>
                <tr>
                    <th>Existing Loan Limit:</th>
                    <td class='existing-loan-limit-field'>${formatNumber(existingLoanLimit)}</td>
                    <td></td>
                </tr>
                <tr>
                    <th>Loan Outstanding(%):</th>
                    <td class='loan-outstanding-field'>${formatNumber(outstandingLoan)}</td>
                    <td>${formatPercentage(loanOutstandingPercent)}</td>
                </tr>
                <tr>
                    <th>Paid Off (%):</th>
                    <td class='paid-off-field'>${formatNumber(paidOff)}</td>
                    <td class='paid-off-field-percent'>${formatPercentage(paidOffPercent)}</td>
                </tr>
                <tr>
                    <th>Required Paid-Off Per Loan Matrix (%):</th>
                    <td class='required-paid-off-field'>${formatNumber(requiredPaidOff)}</td>
                    <td class='required-paid-off-field-percent'>${formatNumber(requiredPaidOffPerLoanMetrics)}%</td>
                </tr>
                <tr>
                    <th>Paid Off Actual Vs Required (%):</th>
                    <td class='paid-off-vs-required-field'>${formatNumber(paidOffVsRequired)}</td>
                    <td class='paid-off-vs-required-field-percent'>${formatPercentage(paidOffVsRequiredPercent)}</td>
                </tr>
            `;

            document.getElementById("tableCalculatorMathsPaidOff").innerHTML = html;
        }


        function generateTurnaroundTable(record) {
    // Helper function to calculate days between two dates
    function calculateDaysBetween(date1, date2) {
        if (!date1 || !date2 || date1 === "Not Received" || date2 === "Not Received") return 0;
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                if (isNaN(d1) || isNaN(d2)) return 0;
                const diffTime = Math.abs(d2 - d1);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            // Format dates
            const applicationDate = formatDate(record.ApplicationDate);
            const appraisalDate = formatDate(record.appraisal_date || "Not Received");
            const bankVerifiedDate = formatDate(record.bank_verified_date || "Not Received");
            const bankProcessedDate = formatDate(record.uploaded_date);
            const approvedDate = formatDate(record.approved_date);

            // Calculate days for each step
            const applicationDays = 0; // Loan Application Date always has 0 days
            const appraisalDays = record.appraisal_date && record.appraisal_date !== "Not Received" ? calculateDaysBetween(record.ApplicationDate, record.appraisal_date) : 0;
            const bankVerifiedDays = record.bank_verified_date && record.bank_verified_date !== "Not Received" ? calculateDaysBetween(record.appraisal_date || record.ApplicationDate, record.bank_verified_date) : 0;
            const bankProcessedDays = record.uploaded_date ? calculateDaysBetween(record.bank_verified_date || record.appraisal_date || record.ApplicationDate, record.uploaded_date) : 0;
            const approvedDays = record.approved_date ? calculateDaysBetween(record.uploaded_date, record.approved_date) : 0;

            // Calculate total turnaround time
            const totalDays = appraisalDays + bankVerifiedDays + bankProcessedDays + approvedDays;

            // Generate HTML table
            return `
                <table class="table table-sm" id="tableTurnaroundTime">
                    <tr>
                        <th>Turnaround Time - TAT</th>
                        <th>Dates</th>
                        <th>Days</th>
                    </tr>
                    <tr>
                        <td>Loan Application Date</td>
                        <td>${applicationDate}</td>
                        <td>${applicationDays}</td>
                    </tr>
                    <tr>
                        <td>Loan Appraisal Date</td>
                        <td>${appraisalDate}</td>
                        <td>${appraisalDays}</td>
                    </tr>
                    <tr>
                        <td>Bank Verified on</td>
                        <td>${bankVerifiedDate}</td>
                        <td>${bankVerifiedDays}</td>
                    </tr>
                    <tr>
                        <td>Bank Processed on</td>
                        <td>${bankProcessedDate}</td>
                        <td>${bankProcessedDays}</td>
                    </tr>
                    <tr>
                        <td>KFT Approved on</td>
                        <td>${approvedDate}</td>
                        <td>${approvedDays}</td>
                    </tr>
                    <tr>
                        <td>Total Turnaround Time</td>
                        <td></td>
                        <td>${totalDays}</td>
                    </tr>
                </table>
            `;
        }


        function generateLoanCeilingTable(record, loanCeilingLoanMetrics) {

            // Check if record is defined and is an object; if not, use empty object
            const safeRecord = (record && typeof record === 'object') ? record : {};

            // Extract input values or set to null if Not Received or invalid
            console.log(safeRecord.existing_loan_exposure_per_ecib)
            const loanExposureECIB = safeRecord.existing_loan_exposure_per_ecib && !isNaN(safeRecord.existing_loan_exposure_per_ecib) ? parseFloat(safeRecord.existing_loan_exposure_per_ecib) : null;
            console.log('loanExposureECIB:- ', loanExposureECIB)
            const outstandingLoan = safeRecord.Existing_Outstanding_Loan_Schedules && !isNaN(safeRecord.Existing_Outstanding_Loan_Schedules) ? parseFloat(safeRecord.Existing_Outstanding_Loan_Schedules) : null;
            const loanCeilingMatrix = loanCeilingLoanMetrics && !isNaN(loanCeilingLoanMetrics) ? parseFloat(loanCeilingLoanMetrics) : null;

            // Calculate Considered Loan Exposure
            // Only calculate if loanExposureECIB is valid; otherwise, set to 0
            const consideredLoanExposure = loanExposureECIB && outstandingLoan ? loanExposureECIB - outstandingLoan : 0;

            // Calculate Cushion for New Loan
            // Only calculate if both loanExposureECIB and loanCeilingMatrix are valid; otherwise, set to 0
            const cushionForNewLoan = loanExposureECIB && loanCeilingMatrix ? loanCeilingMatrix - consideredLoanExposure : 0;

            // Generate HTML table
            html = `
                <tr>
                    <th>Existing Loan Exposure Per ECIB (Yet to Receive):</th>
                    <td>${formatNumber(loanExposureECIB)}</td>
                </tr>
                <tr>
                    <th>Less Existing Loan Outstanding:</th>
                    <td>${formatNumber(outstandingLoan)}</td>
                </tr>
                <tr>
                    <th>Considered Loan Exposure:</th>
                    <td>${formatNumber(consideredLoanExposure)}</td>
                </tr>
                <tr>
                    <th>Loan Ceiling Per Loan Matrix:</th>
                    <td>${formatNumber(loanCeilingMatrix)}</td>
                </tr>
                <tr>
                    <th>Cushion For New Loan:</th>
                    <td>${formatNumber(cushionForNewLoan)}</td>
                </tr>
            `;

            document.getElementById("tableCalculatorMathsLoanCeiling").innerHTML = html;
        }


        function generateLoanLimitTable(record, repeatIncrementPerLoanMetrics) {
            repeatIncrementPerLoanMetrics = parseInt(repeatIncrementPerLoanMetrics);
            repeatIncrementPerLoanMetricsDecimal = parseFloat(repeatIncrementPerLoanMetrics) / 100
            console.log('repeatIncrementPerLoanMetricsDecimal:- ', repeatIncrementPerLoanMetricsDecimal)


            // Check if record is defined and is an object; if not, use empty object
            const safeRecord = (record && typeof record === 'object') ? record : {};

            // Extract input values or set to null if Not Received or invalid
            const loanAmount = safeRecord.Loan_Amount && !isNaN(safeRecord.Loan_Amount) ? parseFloat(safeRecord.Loan_Amount) : null;
            const existingLoanLimit = safeRecord.Existing_Loan_Limit && !isNaN(safeRecord.Existing_Loan_Limit) ? parseFloat(safeRecord.Existing_Loan_Limit) : null;

            // Calculate BCC Approved Loan Amount Percentage
            const bccApprovedPercent = (loanAmount && existingLoanLimit) ? (loanAmount / existingLoanLimit) * 100 : 0;

            // Calculate Increment of Repeat Loan from Existing Limit (Amount and %)
            const incrementLoanAmount = (loanAmount && existingLoanLimit) ? loanAmount - existingLoanLimit : 0;
            const incrementLoanPercent = (incrementLoanAmount && existingLoanLimit) ? (incrementLoanAmount / existingLoanLimit) * 100 : 0;

            // Calculate Required Repeat Loan Limit per Loan Matrix (Amount and %)
            const requiredRepeatLoanLimit = existingLoanLimit ? existingLoanLimit * repeatIncrementPerLoanMetricsDecimal : 0;
            const requiredRepeatLoanPercent = repeatIncrementPerLoanMetrics;
            console.log('repeatIncrementPerLoanMetrics:- ', repeatIncrementPerLoanMetrics)

            // Calculate Required vs Repeat Loan Limit (Amount and %)
            const requiredVsRepeatLoan = (loanAmount && requiredRepeatLoanLimit) ? requiredRepeatLoanLimit - loanAmount : 0;
            const requiredVsRepeatLoanPercent = (requiredVsRepeatLoan && existingLoanLimit) ? (requiredVsRepeatLoan / existingLoanLimit) * 100 : 0;

            // Generate HTML table
            html = `
                <tr>
                    <th>BCC Approved Loan Amount:</th>
                    <td>${formatNumber(loanAmount)}</td>
                    <td>${formatPercentage(bccApprovedPercent)}</td>
                </tr>
                <tr>
                    <th>Increment of Repeat Loan from Existing Limit (%):</th>
                    <td>${formatNumber(incrementLoanAmount)}</td>
                    <td>${formatPercentage(incrementLoanPercent)}</td>
                </tr>
                <tr>
                    <th>Required Repeat Loan Limit Per Loan Matrix (%):</th>
                    <td>${formatNumber(requiredRepeatLoanLimit)}</td>
                    <td>${formatPercentage(requiredRepeatLoanPercent)}</td>
                </tr>
                <tr>
                    <th>Required vs Repeat Loan Limit (%):</th>
                    <td>${formatNumber(requiredVsRepeatLoan)}</td>
                    <td>${formatPercentage(requiredVsRepeatLoanPercent)}</td>
                </tr>
            `;

            document.getElementById("tableCalculatorMathsLoanLimit").innerHTML = html;
        }

        function findMatchingLoanMetric(
          data,
          productCode,
          applicantGender,
          natureOfBusiness = undefined,
          experienceYear = undefined
        ) {
            console.log('---findMatchingLoanMetric---')
            console.log('data:- ', data)
            console.log('productCode, applicantGender, natureOfBusiness, experienceYear');
            console.log(productCode, applicantGender, natureOfBusiness, experienceYear);

          // helper to normalize values
          const normalize = (val) =>
            val === undefined || val === null
              ? ""
              : val.toString().trim().toLowerCase().replace(/\s+/g, "_");

          return data.find((record) => {
            const matchProduct =
              normalize(record.product_name || "") === normalize(productCode);
            const matchGender =
              normalize(record.gender || "") === normalize(applicantGender);

            const matchBusiness = !natureOfBusiness || normalize(record.occupation_name || "") === normalize(natureOfBusiness);

            const matchExperience =!experienceYear || normalize(record.experience_label || "") === normalize(experienceYear);

            return matchProduct && matchGender && matchBusiness && matchExperience;
          });
        }


        // Function to check against loan metrics via AJAX
        function checkAgainstLoanMetrics(data, natureOfBusiness, experience) {
            console.log('---checkAgainstLoanMetrics---')
            console.log('data:- ', data)
            const productCode = data.LoanProductCode;
            const applicantGender = data.Gender;

            console.log(productCode, applicantGender, natureOfBusiness, experience);

            const proposedLoanMetric = findMatchingLoanMetric(loanMetrics, productCode, applicantGender, natureOfBusiness, experience);
            console.log(proposedLoanMetric);

            let interest_rate = 0;
            let loanCeilingLoanMetrics = 0;
            let requiredPaidOffPerLoanMetrics = 0;
            let repeatIncrementPerLoanMetrics = 0;

            if(proposedLoanMetric)
            {
                interest_rate = proposedLoanMetric.interest_rate || 0;
                console.log(interest_rate);

                loanCeilingLoanMetrics = proposedLoanMetric.global_loan_ceiling || 0;
                console.log(loanCeilingLoanMetrics);

                requiredPaidOffPerLoanMetrics =  proposedLoanMetric.required_paid_off || 0;
                console.log(requiredPaidOffPerLoanMetrics);

                repeatIncrementPerLoanMetrics = proposedLoanMetric.repeat_increment || 0;
                console.log(repeatIncrementPerLoanMetrics);
            }

            generateLoanStatusTable(data, requiredPaidOffPerLoanMetrics);
            generateLoanCeilingTable(data, loanCeilingLoanMetrics);
            generateLoanLimitTable(data, repeatIncrementPerLoanMetrics);

            document.getElementById('td-interest-rate').innerHTML = interest_rate + "%";
        }

        // View letter in modal
        function viewLetter(pre_disb_temp_id, email_sent) {
            console.log(email_sent)
            const iframe = document.getElementById('letter-iframe');
            const errorDiv = document.getElementById('letter-error');
            const sendEmailBtn = document.getElementById('send-email-btn');
            iframe.classList.add('loading');
            errorDiv.style.display = 'none';
            sendEmailBtn.style.display = 'none';
            iframe.src = `/approval-letter/${pre_disb_temp_id}`;

            iframe.onload = function() {
                iframe.classList.remove('loading');
                if (iframe.contentDocument.body.innerHTML.trim() === '') {
                    errorDiv.style.display = 'block';
                    iframe.style.display = 'none';
                } else {
                    iframe.style.display = 'block';
                    if(String(email_sent) === '2'){
                        sendEmailBtn.style.display = 'none';
                    }
                    else{
                        sendEmailBtn.style.display = 'block';
                    }
                }
            };

            iframe.onerror = function() {
                iframe.classList.remove('loading');
                errorDiv.style.display = 'block';
                iframe.style.display = 'none';
            };

            const modal = new bootstrap.Modal(document.getElementById('letterModal'));
            modal.show();
        }

        // Show email modal
        function showEmailModal() {
            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            modal.show();
        }

        // Send email
        document.getElementById('send-email-confirm-btn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = `Sending... <i class="fas fa-spinner fa-spin ml-2 ms-2"></i>`;

            const iframe = document.getElementById('letter-iframe');
            const recipientEmail = document.getElementById('recipient-email').value;
            const appNo = iframe.src.split('/approval-letter/')[1];
            if (!recipientEmail || !appNo) {
                this.disabled = false;
                this.innerHTML = `Send`;
                showToast('Please enter a valid email address.', 3000);
                return;
            }

            fetch('/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ app_no: appNo, recipient_email: recipientEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.disabled = false;
                    this.innerHTML = `Send`;
                    showToast(data.message, 3000);
                    bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
                } else {
                    this.disabled = false;
                    this.innerHTML = `Send`;
                    showToast('Error: ' + data.error, 3000, 'warning');
                }
            })
            .catch(error => {
                this.disabled = false;
                this.innerHTML = `Send`;
                showToast('Error sending email: ' + error.message, 3000, 'warning');
            });
        });

        // Save temp record via AJAX
        function saveTempRecord(pre_disb_temp_id, saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = `Saving... <i class="fas fa-spinner fa-spin ml-2 ms-2"></i>`;

            const status = document.getElementById('temp-status').value;
            const notes = document.getElementById('temp-notes').value;
            const amount_accepted = document.getElementById('amount-accepted').value;

            fetch('/update-pre-disbursement-temp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pre_disb_temp_id: pre_disb_temp_id,
                    status: status,
                    Notes: notes,
                    amount_accepted: amount_accepted
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const record = tempData.find(r => r.pre_disb_temp_id === pre_disb_temp_id);
                    if (record) {
                        record.status = status;
                        record.Notes = notes;
                        applyFilters(); // Re-apply filters to update the table
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = `Save`;
                        showToast('Record updated successfully', 3000);

                        setTimeout(function(){
                            window.location.reload();
                        }, 3000);
                    }
                } else {
                    showToast('Error updating record: ' + (data.error || 'Unknown error'), 3000);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `Save`;
                }
            })
            .catch(error => {
                showToast('Error updating record: ' + error.message, 3000);
                saveBtn.disabled = false;
                saveBtn.innerHTML = `Save`;
            });
        }

        // View on-going loan details
        function viewOngoingLoan(event) {
            event.preventDefault();
            const modalBody = document.getElementById('temp-modal-body');
            const index = parseInt(modalBody.getAttribute('data-index'), 10);
            const record = filteredData[index];

            if (!record || !record.CNIC) {
                showToast('No valid record found to fetch on-going loan details.', 3000, 'warning');
                return;
            }

            const cnic = record.CNIC;
            const appNo = record.Application_No;
            const modalTitle = document.getElementById('ongoingLoanModalLabel');
            modalTitle.textContent = `${appNo} (On-going Loan)`;
            const modalBodyOngoing = document.getElementById('ongoing-loan-body');
            const loadingDiv = document.getElementById('ongoing-loading');
            const table = document.getElementById('ongoing-loan-table');
            const errorDiv = document.getElementById('ongoing-error');
            const tbody = document.getElementById('ongoing-loan-table-body');

            loadingDiv.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';
            tbody.innerHTML = '';

            fetch(`/get_on_going_loan_details?cnic=${encodeURIComponent(cnic)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                if (data.success && data.records.length > 0) {
                    table.style.display = 'table';
                    data.records.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.mis_date || 'Not Received'}</td>
                            <td>${record.cnic || 'Not Received'}</td>
                            <td>${record.disbursed_amount || 'Not Received'}</td>
                            <td>${record.booked_on || 'Not Received'}</td>
                            <td>${record.principal_outstanding || 'Not Received'}</td>
                            <td>${record.markup_outstanding || 'Not Received'}</td>
                            <td>${record.purpose || 'Not Received'}</td>
                            <td>${record.loan_status || 'Not Received'}</td>
                            <td>${record.overdue_days || 'Not Received'}</td>
                            <td>${formatDate(record.loan_closed_on) || 'Not Received'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    errorDiv.style.display = 'block';
                }
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                console.error('Error fetching on-going loan details:', error);
            });

            const ongoingModal = new bootstrap.Modal(document.getElementById('ongoingLoanModal'));
            ongoingModal.show();
        }

        // Export to Excel (CSV)
        function exportToExcel() {
            let csv = 'Application No,Branch,Loan Product,Borrower Name,Loan Amount,Reason,Rejected By,Rejected Date\n';
            filteredData.forEach(record => {
                csv += `${record.Application_No || 'Not Received'},${record.Branch_Name || 'Not Received'},${record.LoanProductCode || 'Not Received'},${record.Borrower_Name || 'Not Received'},${record.Loan_Amount || 'Not Received'},${(record.notes || 'Not Received').replace(/,/g, ';')},${record.rejected_by || 'Not Received'},${formatDate(record.rejected_date) || 'Not Received'}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'disagreed_loans.csv';
            link.click();
        }

        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({
                head: [['Application No', 'Branch', 'Loan Product', 'Borrower Name', 'Loan Amount', 'Reason', 'Rejected By', 'Rejected Date']],
                body: filteredData.map(record => [
                    record.Application_No || 'Not Received',
                    record.Branch_Name || 'Not Received',
                    record.LoanProductCode || 'Not Received',
                    record.Borrower_Name || 'Not Received',
                    record.Loan_Amount || 'Not Received',
                    record.notes || 'Not Received',
                    record.rejected_by || 'Not Received',
                    formatDate(record.rejected_date) || 'Not Received'
                ]),
            });
            doc.save('disagreed_loans.pdf');
        }

        // Print the table
        function printTable() {
            const printContent = document.getElementById('print-table').outerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            window.location.reload(); // Reload to restore page
        }

        // Initial render
        applyFilters();
    </script>
</body>
</html>