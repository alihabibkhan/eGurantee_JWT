<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'head.html' %}
    <title>Manage Meeting Setup</title>
    <style>
        .table-responsive {
            margin-bottom: 1rem;
        }
        .card {
            margin-top: 1rem;
        }
        .action-icons a {
            margin-right: 8px;
            cursor: pointer;
        }
        .add-btn {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url": "", "label": "Manage Meeting Setup"}]) }}

    <div class="container mt-4">
        {% include 'message_box.html' %}

        <div class="card">
            <div class="card-header">
                <h2>Manage Meeting Setup</h2>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="meetingSetupTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="meeting-categories-tab" data-bs-toggle="tab" data-bs-target="#meeting-categories" href="#meeting-categories" role="tab" aria-controls="meeting-categories" aria-selected="true">Meeting Categories</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="meeting-frequencies-tab" data-bs-toggle="tab" href="#meeting-frequencies" data-bs-target="#meeting-frequencies" role="tab" aria-controls="meeting-frequencies" aria-selected="false">Meeting Frequencies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="meeting-priorities-tab" data-bs-toggle="tab" href="#meeting-priorities" data-bs-target="#meeting-priorities" role="tab" aria-controls="meeting-priorities" aria-selected="false">Meeting Priorities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="pre-meeting-status-tab" data-bs-toggle="tab" href="#pre-meeting-status" data-bs-target="#pre-meeting-status" role="tab" aria-controls="pre-meeting-status" aria-selected="false">Meeting Status</a>
                    </li>
                    <!--
                    <li class="nav-item">
                        <a class="nav-link" id="post-meeting-status-tab" data-bs-toggle="tab" href="#post-meeting-status" data-bs-target="#post-meeting-status" role="tab" aria-controls="post-meeting-status" aria-selected="false">Post-Meeting Status</a>
                    </li>
                    -->
                    <li class="nav-item d-none">
                        <a class="nav-link" id="meeting-action-items-tab" data-bs-toggle="tab" href="#meeting-action-items" data-bs-target="#meeting-action-items" role="tab" aria-controls="meeting-action-items" aria-selected="false">Meeting Action Items</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="meeting-action-items-priorities-tab" data-bs-toggle="tab" href="#meeting-action-items-priorities" data-bs-target="#meeting-action-items-priorities" role="tab" aria-controls="meeting-action-items-priorities" aria-selected="false">Action Item Priorities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="meeting-action-items-status-tab" data-bs-toggle="tab" href="#meeting-action-items-status" data-bs-target="#meeting-action-items-status" role="tab" aria-controls="meeting-action-items-status" aria-selected="false">Action Item Status</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="mandatory-meetings-tab" data-bs-toggle="tab" href="#mandatory-meetings" data-bs-target="#mandatory-meetings" role="tab" aria-controls="mandatory-meetings" aria-selected="false">Recurring Meetings</a>
                    </li>
                </ul>

                <div class="tab-content" id="meetingSetupTabContent">
                    <!-- Meeting Categories Tab -->
                    <div class="tab-pane fade show active" id="meeting-categories" role="tabpanel" aria-labelledby="meeting-categories-tab">
                        <h3 class="mt-3">Meeting Categories</h3>
                        <a href="{{ url_for('add_edit_meeting_category') }}" class="btn btn-primary mb-3 add-btn">Add Meeting Category</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Category Code</th>
                                        <th>Category Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in result.get_all_meeting_categories %}
                                    <tr>
                                        <td>{{ category.meeting_category_code or '' }}</td>
                                        <td>{{ category.meeting_category_name or '' }}</td>
                                        <td>{{ category.created_by or '' }}</td>
                                        <td>{{ category.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_category', meeting_category_id=category.meeting_category_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_category', meeting_category_id=category.meeting_category_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meeting Frequencies Tab -->
                    <div class="tab-pane fade" id="meeting-frequencies" role="tabpanel" aria-labelledby="meeting-frequencies-tab">
                        <h3 class="mt-3">Meeting Frequencies</h3>
                        <a href="{{ url_for('add_edit_meeting_frequency') }}" class="btn btn-primary mb-3 add-btn">Add Meeting Frequency</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Min Frequency</th>
                                        <th>Max Frequency</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for frequency in result.get_all_meeting_frequencies %}
                                    <tr>
                                        <td>{{ frequency.meeting_freq_title or '' }}</td>
                                        <td>{{ frequency.min_freq or '' }}</td>
                                        <td>{{ frequency.max_freq or '' }}</td>
                                        <td>{{ frequency.created_by or '' }}</td>
                                        <td>{{ frequency.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_frequency', meeting_freq_id=frequency.meeting_freq_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_frequency', meeting_freq_id=frequency.meeting_freq_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meeting Priorities Tab -->
                    <div class="tab-pane fade" id="meeting-priorities" role="tabpanel" aria-labelledby="meeting-priorities-tab">
                        <h3 class="mt-3">Meeting Priorities</h3>
                        <a href="{{ url_for('add_edit_meeting_priority') }}" class="btn btn-primary mb-3 add-btn">Add Meeting Priority</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for priority in result.get_all_meeting_priorities %}
                                    <tr>
                                        <td>{{ priority.meeting_priority_name or '' }}</td>
                                        <td>{{ priority.created_by or '' }}</td>
                                        <td>{{ priority.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_priority', meeting_priority_id=priority.meeting_priority_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_priority', meeting_priority_id=priority.meeting_priority_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pre-Meeting Status Tab -->
                    <div class="tab-pane fade" id="pre-meeting-status" role="tabpanel" aria-labelledby="pre-meeting-status-tab">
                        <h3 class="mt-3">Meeting Status</h3>
                        <a href="{{ url_for('add_edit_pre_meeting_status') }}" class="btn btn-primary mb-3 add-btn">Add Meeting Status</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in result.get_all_pre_meeting_status %}
                                    <tr>
                                        <td>{{ status.pre_ms_name or '' }}</td>
                                        <td>{{ status.created_by or '' }}</td>
                                        <td>{{ status.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_pre_meeting_status', pre_ms_id=status.pre_ms_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_pre_meeting_status', pre_ms_id=status.pre_ms_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Post-Meeting Status Tab -->
                    <div class="tab-pane fade" id="post-meeting-status" role="tabpanel" aria-labelledby="post-meeting-status-tab">
                        <h3 class="mt-3">Post-Meeting Status</h3>
                        <a href="{{ url_for('add_edit_post_meeting_status') }}" class="btn btn-primary mb-3 add-btn">Add Post-Meeting Status</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in result.get_all_post_meeting_status %}
                                    <tr>
                                        <td>{{ status.post_ms_name or '' }}</td>
                                        <td>{{ status.created_by or '' }}</td>
                                        <td>{{ status.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_post_meeting_status', post_ms_id=status.post_ms_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_post_meeting_status', post_ms_id=status.post_ms_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meeting Action Items Tab -->
                    <div class="tab-pane fade" id="meeting-action-items" role="tabpanel" aria-labelledby="meeting-action-items-tab">
                        <h3 class="mt-3">Meeting Action Items</h3>
                        <a href="{{ url_for('add_edit_meeting_action_item') }}" class="btn btn-primary mb-3 add-btn">Add Meeting Action Item</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in result.get_all_meeting_action_items %}
                                    <tr>
                                        <td>{{ item.mai_name or '' }}</td>
                                        <td>{{ item.created_by or '' }}</td>
                                        <td>{{ item.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_action_item', mai_id=item.mai_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_action_item', mai_id=item.mai_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meeting Action Items Priorities Tab -->
                    <div class="tab-pane fade" id="meeting-action-items-priorities" role="tabpanel" aria-labelledby="meeting-action-items-priorities-tab">
                        <h3 class="mt-3">Meeting Action Item Priorities</h3>
                        <a href="{{ url_for('add_edit_meeting_action_item_priority') }}" class="btn btn-primary mb-3 add-btn">Add Action Item Priority</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for priority in result.get_all_meeting_action_items_priorities %}
                                    <tr>
                                        <td>{{ priority.maip_name or '' }}</td>
                                        <td>{{ priority.created_by or '' }}</td>
                                        <td>{{ priority.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_action_item_priority', maip_id=priority.maip_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_action_item_priority', maip_id=priority.maip_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Meeting Action Items Status Tab -->
                    <div class="tab-pane fade" id="meeting-action-items-status" role="tabpanel" aria-labelledby="meeting-action-items-status-tab">
                        <h3 class="mt-3">Meeting Action Item Status</h3>
                        <a href="{{ url_for('add_edit_meeting_action_item_status') }}" class="btn btn-primary mb-3 add-btn">Add Action Item Status</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for status in result.get_all_meeting_action_items_status %}
                                    <tr>
                                        <td>{{ status.mais_name or '' }}</td>
                                        <td>{{ status.created_by or '' }}</td>
                                        <td>{{ status.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_meeting_action_item_status', mais_id=status.mais_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_meeting_action_item_status', mais_id=status.mais_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recurring Meetings Tab -->
                    <div class="tab-pane fade" id="mandatory-meetings" role="tabpanel" aria-labelledby="mandatory-meetings-tab">
                        <h3 class="mt-3">Recurring Meetings</h3>
                        <a href="{{ url_for('add_edit_mandatory_meeting') }}" class="btn btn-primary mb-3 add-btn">Add Recurring Meeting</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Frequency</th>
                                        <th>Proposed Month</th>
                                        <th>NC Distribution</th>
                                        <th>Responsible Committee</th>
                                        <th>Priority</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for meeting in result.get_all_mandatory_meetings %}
                                    <tr>
                                        <td>{{ meeting.meeting_category_name or '' }} - {{ meeting.meeting_category_code or '' }}</td>
                                        <td>{{ meeting.meeting_freq_title or '' }}</td>
                                        <td>{{ meeting.proposed_month|month_year_short }}</td>
                                        <td>{{ meeting.nc_disb_id or '' }}</td>
                                        <td>{{ meeting.resp_committ or '' }}</td>
                                        <td>{{ meeting.meeting_priority_name or '' }}</td>
                                        <td>{{ meeting.created_by or '' }}</td>
                                        <td>{{ meeting.created_date|format_date }}</td>
                                        <td>
                                            <a href="#" class="text-decoration-none" title="View" data-bs-toggle="modal" data-bs-target="#meetingDetailModal" onclick="showMeetingDetails('{{ meeting.mand_meet_id }}')">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('add_edit_mandatory_meeting', mand_meet_id=meeting.mand_meet_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_mandatory_meeting', mand_meet_id=meeting.mand_meet_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Recurring Meeting Details -->
    <div class="modal fade" id="meetingDetailModal" tabindex="-1" aria-labelledby="meetingDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="meetingDetailModalLabel">Recurring Meeting Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tbody id="meeting-detail-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask with fallback
        const meetingData = {{ result.get_all_mandatory_meetings | tojson | safe }} || [];

        // Validate data
        if (!Array.isArray(meetingData)) {
            console.error('Invalid meeting data:', meetingData);
            const tbody = document.querySelector('#mandatory-meetings tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Error loading data</td></tr>';
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return isNaN(date) ? dateStr : date.toLocaleDateString('en-US', { timeZone: 'Asia/Karachi' });
        }

        // Show mandatory meeting details in modal
        function showMeetingDetails(mandMeetId) {
            // Find the record by mand_meet_id
            const record = meetingData.find(r => String(r.mand_meet_id) === String(mandMeetId));
            if (!record) {
                console.error('Meeting not found for ID:', mandMeetId);
                return;
            }

            const tbody = document.getElementById('meeting-detail-body');
            tbody.innerHTML = '';
            const fields = [
                { key: 'meeting_category_name', label: 'Category' },
                { key: 'meeting_freq_title', label: 'Frequency' },
                { key: 'proposed_month', label: 'Proposed Month', format: formatDate },
                { key: 'nc_disb_id', label: 'NC Disb ID' },
                { key: 'resp_committ', label: 'Responsible Committee' },
                { key: 'meeting_priority_name', label: 'Priority' },
                { key: 'created_by', label: 'Created By' },
                { key: 'created_date', label: 'Created Date', format: formatDate },
                { key: 'status', label: 'Status' }
            ];

            fields.forEach(field => {
                if (field.key !== 'mand_meet_id') { // Exclude primary key
                    const row = document.createElement('tr');
                    const value = field.format ? field.format(record[field.key]) : (record[field.key] || 'N/A');
                    row.innerHTML = `
                        <th>${field.label}</th>
                        <td>${value}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Handle tab navigation
        document.addEventListener("DOMContentLoaded", function () {
            // Activate tab if URL contains hash
            let hash = window.location.hash;
            if (hash) {
                let triggerEl = document.querySelector(`[data-bs-target="${hash}"]`);
                if (triggerEl) {
                    let tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }

            // Update hash when tab is changed
            let tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
            tabLinks.forEach(function (el) {
                el.addEventListener("shown.bs.tab", function (event) {
                    let target = event.target.getAttribute("data-bs-target");
                    history.replaceState(null, null, target); // updates URL hash
                });
            });
        });
    </script>
</body>
</html>